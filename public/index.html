<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUI Game Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1, h2, h3 { margin-bottom: 0.5rem; }
    button { margin: 0.5rem 0; }
    ul { padding-left: 1.2rem; margin-bottom: 1rem; }
    #game-state { background: #73cbf1; padding: 1rem; margin-top: 2rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>SUI Game Dashboard</h1>

  <button id="btn-load-players">Reload Players</button>
  <ul id="players"></ul>

  <button id="btn-add-player">Add Dummy Player</button>

  <h2>Player Cast</h2>
  <div>
    <label for="cast-player-id">Player ID:</label>
    <input type="text" id="cast-player-id" placeholder="player_..." style="width:200px; margin:0 .5rem;">
    <input type="text" id="cast-input" placeholder="e.g. 5,3,9,1" style="width:200px;">
    <button id="btn-cast">Submit Cast</button>
    <button id="btn-claim">Claim Catch</button>
  </div>

  <!-- Game State Panel -->
  <div id="game-state">
    <h2>Game State</h2>
    <div>Phase: <strong><span id="state-phase">–</span></strong></div>
    <div>Event: <strong><span id="state-event">–</span></strong></div>

    <h3>Players</h3>
    <ul id="state-players"></ul>

    <h3>Pending Casts</h3>
    <ul id="state-playercasts"></ul>

    <h3>Unclaimed Catches</h3>
    <ul id="state-unclaimed"></ul>

    <h3>Catch History</h3>
    <ul id="state-history"></ul>
  </div>

  <script>
    // — Utilities —
    async function getJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(res.statusText);
      return res.json();
    }

    // — Players UI —
    async function loadPlayers() {
      const ul = document.getElementById('players');
      ul.textContent = 'Loading…';
      try {
        const players = await getJSON('/players');
        ul.innerHTML = Object.entries(players)
          .map(([id, st]) => `<li>${id}: wins=${st.wins}, plays=${st.plays}</li>`)
          .join('') || '<li><em>(no players)</em></li>';
      } catch (e) {
        ul.innerHTML = `<li style="color:red">${e.message}</li>`;
      }
    }

    async function addDummyPlayer() {
      const id = 'player_' + Date.now();
      const wins = Math.floor(Math.random()*10), plays = Math.floor(Math.random()*20);
      await fetch(`/player/${id}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ wins, plays })
      });
      loadPlayers();
      refreshState();
    }

    // — Casting & Claiming —
    async function submitCast() {
      const playerId = document.getElementById('cast-player-id').value.trim();
      const raw = document.getElementById('cast-input').value;
      const cast = raw.split(',').map(n=>parseInt(n,10)).filter(n=>Number.isInteger(n));
      if (!playerId || cast.length===0) return alert('Need ID + valid ints');
      const resp = await fetch('/playercast', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ playerId, cast })
      });
      const j = await resp.json();
      if (!j.success) return alert('Error: '+j.error);
      loadPlayers(); refreshState();
    }
    async function claimCatch() {
      const playerId = document.getElementById('cast-player-id').value.trim();
      if (!playerId) return alert('Enter Player ID');
      const resp = await fetch('/claim', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ playerId })
      });
      const j = await resp.json();
      if (!j.success) return alert('Error: '+j.error);
      alert('Claimed: '+JSON.stringify(j.claimed));
      refreshState();
    }

    // — Game State Panel —
    async function refreshState() {
      try {
        // phase & event
        const { phase, event } = await getJSON('/state');
        document.getElementById('state-phase').textContent = phase;
        document.getElementById('state-event').textContent = event||'None';

        // players
        const players = await getJSON('/players');
        document.getElementById('state-players').innerHTML = Object.entries(players)
          .map(([id,st])=>`<li>${id}: wins=${st.wins}, plays=${st.plays}</li>`).join('') || '<li>(none)</li>';

        // pending casts
        const casts = await getJSON('/playercasts');
        document.getElementById('state-playercasts').innerHTML = casts
          .map(c=>`<li>${c.playerId}: [${c.cast.join(', ')}] @${new Date(c.timestamp).toLocaleTimeString()}</li>`)
          .join('') || '<li>(none)</li>';

        // unclaimed
        const unclaimed = await getJSON('/unclaimed');
        document.getElementById('state-unclaimed').innerHTML = unclaimed
          .map(c=>`<li>${c.playerId}: ${c.catch.type} @${new Date(c.at).toLocaleTimeString()}</li>`)
          .join('') || '<li>(none)</li>';

        // history
        const history = await getJSON('/history');
        document.getElementById('state-history').innerHTML = history
          .map((c,i)=>`<li>#${i+1} ${c.playerId}: ${c.catch.type} (${c.event||'none'}) @${new Date(c.at).toLocaleTimeString()}</li>`)
          .join('') || '<li>(none)</li>';
      } catch (e) {
        console.error('refreshState error', e);
      }
    }

    // — Event wiring & initial load —
    document.getElementById('btn-load-players').onclick = loadPlayers;
    document.getElementById('btn-add-player').onclick  = addDummyPlayer;
    document.getElementById('btn-cast').onclick        = submitCast;
    document.getElementById('btn-claim').onclick       = claimCatch;

    loadPlayers();
    refreshState();
    setInterval(refreshState, 5000);
  </script>
</body>
</html>
