<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUI Game Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 800px; margin: auto; }
    h1 { margin-bottom: 1rem; }
    section { margin-bottom: 2rem; }
    button { margin-right: .5rem; }
    label { margin-right: .5rem; }
    input { margin-right: 1rem; }
    #game-state { background: #eef9ff; padding: 1rem; border-radius: 8px; }
    #game-state h2 { margin-top: 0; }
    ul { padding-left: 1.2rem; }
    li { margin-bottom: .3rem; }
  </style>
</head>
<body>
  <h1>SUI Game Dashboard</h1>

  <section>
    <h2>Cast / Claim</h2>
    <label for="cast-player-id">Player ID</label>
    <input type="text" id="cast-player-id" placeholder="player_..." style="width:180px;">
    <label for="cast-input">Cards (e.g. 5,3,9)</label>
    <input type="text" id="cast-input" placeholder="comma-separated" style="width:200px;">
    <button id="btn-cast">Cast</button>
    <button id="btn-claim">Claim</button>
    <button id="btn-cast-all">Cast All (Random)</button>
    <button id="btn-claim-all">Claim All</button>
  </section>

  <section id="game-state">
    <h2>Game State</h2>
    <div>Phase: <strong><span id="state-phase">–</span></strong></div>
    <div>Hour:  <strong><span id="state-hour">–</span></strong></div>
    <div>Event: <strong><span id="state-event">–</span></strong></div>

    <h3>Players</h3>
    <ul id="state-players"><li><em>loading…</em></li></ul>

    <h3>Pending Casts</h3>
    <ul id="state-playercasts"><li><em>loading…</em></li></ul>

    <h3>Unclaimed Catches</h3>
    <ul id="state-unclaimed"><li><em>loading…</em></li></ul>

    <h3>Catch History</h3>
    <ul id="history-list"><li><em>loading…</em></li></ul>
  </section>

  <script>
    // — Helpers —
    async function getJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(res.statusText);
      return res.json();
    }

    // — Single Cast / Claim —
    async function submitCastFor(playerId, cast) {
      return fetch('/playercast', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ playerId, cast })
      });
    }
    async function submitClaimFor(playerId) {
      return fetch('/claim', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ playerId })
      });
    }

    async function submitCast() {
      const id  = document.getElementById('cast-player-id').value.trim();
      const raw = document.getElementById('cast-input').value;
      const cast = raw.split(',').map(n=>parseInt(n,10)).filter(n=>Number.isInteger(n));
      if (!id || cast.length===0) return alert('Need player ID and at least one valid card index');
      const res = await submitCastFor(id, cast);
      const j   = await res.json();
      if (!j.success) return alert('Error: ' + j.error);
      refreshState();
    }

    async function submitClaim() {
      const id = document.getElementById('cast-player-id').value.trim();
      if (!id) return alert('Need player ID');
      const res = await submitClaimFor(id);
      const j   = await res.json();
      if (!j.success) return alert('Error: ' + j.error);
      alert(`Claimed: ${j.claimed.catch.type} @ ${new Date(j.claimed.at).toLocaleTimeString()}`);
      refreshState();
    }

    // — Cast All (random 3 cards each) —
    const MAX_CARD_INDEX = 16;  // update if you ever add more
    function randomCast() {
      return Array.from({length:3}, () => Math.floor(Math.random()*(MAX_CARD_INDEX+1)));
    }
    async function castForAll() {
      try {
        const players = await getJSON('/players');
        for (const id of Object.keys(players)) {
          const cast = randomCast();
          const res  = await submitCastFor(id, cast);
          const j    = await res.json();
          console.log(res.ok
            ? `✅ [${id}] cast [${cast}] queued`
            : `❌ [${id}] cast failed: ${j.error}`
          );
        }
      } catch (e) {
        console.error('castForAll error', e);
        alert('Could not load players');
      }
      refreshState();
    }

    // — Claim All —
    async function claimAll() {
      try {
        const unclaimed = await getJSON('/unclaimed');
        for (const c of unclaimed) {
          const id = c.playerId;
          const res = await submitClaimFor(id);
          const j   = await res.json();
          console.log(res.ok
            ? `✅ [${id}] claimed`
            : `❌ [${id}] claim failed: ${j.error}`
          );
        }
      } catch (e) {
        console.error('claimAll error', e);
        alert('Could not load unclaimed');
      }
      refreshState();
    }

    // — Refresh Everything —
    async function refreshState() {
      try {
        // Phase / Event / Hour
        const { phase, event, hour } = await getJSON('/state');
        document.getElementById('state-phase').textContent = phase;
        document.getElementById('state-event').textContent = event || 'None';
        document.getElementById('state-hour').textContent  = hour != null ? hour : '–';

        // Players
        const players = await getJSON('/players');
        document.getElementById('state-players').innerHTML = Object.entries(players)
          .map(([id,s])=>`<li>${id}: wins=${s.wins}, plays=${s.plays}</li>`).join('') ||
          '<li><em>(no players)</em></li>';

        // Pending Casts
        const casts = await getJSON('/playercasts');
        document.getElementById('state-playercasts').innerHTML = casts
          .map(c=>`<li>${c.playerId}: [${c.cast.join(', ')}] @${new Date(c.timestamp).toLocaleTimeString()}</li>`)
          .join('') || '<li><em>(none)</em></li>';

        // Unclaimed
        const unclaimed = await getJSON('/unclaimed');
        document.getElementById('state-unclaimed').innerHTML = unclaimed
          .map(c=>`<li>${c.playerId}: ${c.catch.type} @${new Date(c.at).toLocaleTimeString()}</li>`)
          .join('') || '<li><em>(none)</em></li>';

        // History
        const history = await getJSON('/history');
        document.getElementById('history-list').innerHTML = history
          .map(line=>`<li>${line}</li>`).join('') ||
          '<li><em>(none)</em></li>';
      } catch (e) {
        console.error('refreshState error', e);
      }
    }

    // — Wire up buttons & auto-refresh —
    document.getElementById('btn-cast').onclick      = submitCast;
    document.getElementById('btn-claim').onclick     = submitClaim;
    document.getElementById('btn-cast-all').onclick  = castForAll;
    document.getElementById('btn-claim-all').onclick = claimAll;

    refreshState();
    setInterval(refreshState, 5000);
  </script>
</body>
</html>
