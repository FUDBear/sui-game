<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUI Game Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 800px; margin: auto; }
    h1 { margin-bottom: 1rem; }
    section { margin-bottom: 2rem; }
    button { margin-right: .5rem; }
    label { margin-right: .5rem; }
    input { margin-right: 1rem; }
    #game-state { background: #eef9ff; padding: 1rem; border-radius: 8px; }
    #game-state h2 { margin-top: 0; }
    ul { padding-left: 1.2rem; }
    li { margin-bottom: .3rem; }
  </style>
</head>
<body>
  <h1>SUI Game Dashboard</h1>

  <section>
    <h2>Cast / Claim / Init</h2>
    <label for="cast-player-id">Player ID</label>
    <input type="text" id="cast-player-id" placeholder="player_..." style="width:180px;">
    <label for="cast-input">Cards (e.g. 5,3,9)</label>
    <input type="text" id="cast-input" placeholder="comma-separated" style="width:200px;">
    <button id="btn-init">Init Player</button>
    <button id="btn-cast">Cast</button>
    <button id="btn-claim">Claim</button>
    <button id="btn-cast-all">Cast All (Random)</button>
    <button id="btn-claim-all">Claim All</button>
    <button id="btn-refill">Refill Decks</button>
  </section>

  <section id="game-state">
    <h2>Game State</h2>
    <div>Phase: <strong><span id="state-phase">–</span></strong></div>
    <div>Hour:  <strong><span id="state-hour">–</span></strong></div>
    <div>Event: <strong><span id="state-event">–</span></strong></div>

    <h3>Players</h3>
    <ul id="state-players"><li><em>loading…</em></li></ul>

    <h3>Pending Casts</h3>
    <ul id="state-playercasts"><li><em>loading…</em></li></ul>

    <h3>Unclaimed Catches</h3>
    <ul id="state-unclaimed"><li><em>loading…</em></li></ul>

    <h3>Catch History</h3>
    <ul id="history-list"><li><em>loading…</em></li></ul>
  </section>

  <script>
    // — Helpers —
    async function getJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(res.statusText);
      return res.json();
    }

    // — Refill Decks —
    async function refillDecks() {
      try {
        const res = await fetch('/players/refill-decks', { method: 'POST' });
        const j   = await res.json();
        if (!j.success) return alert('Refill failed');
        alert('Decks refilled for all players');
        refreshState();
      } catch (e) {
        console.error('refillDecks error', e);
        alert('Error contacting server');
      }
    }

    // — Single Cast / Claim / Init —
    async function submitInitFor(playerId) {
      return fetch('/player/init', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ playerId })
      });
    }
    async function submitCastFor(playerId, cast) {
      return fetch('/playercast', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ playerId, cast })
      });
    }
    async function submitClaimFor(playerId) {
      return fetch('/claim', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ playerId })
      });
    }

    async function submitInit() {
      const id = document.getElementById('cast-player-id').value.trim();
      if (!id) return alert('Need player ID');
      const res = await submitInitFor(id);
      const j   = await res.json();
      if (!res.ok) alert('Error: ' + j.error);
      else alert(j.created
        ? `Player "${id}" created with state: ${JSON.stringify(j.state)}`
        : `Player "${id}" already exists with state: ${JSON.stringify(j.state)}`);
      refreshState();
    }

    async function submitCast() {
      const id  = document.getElementById('cast-player-id').value.trim();
      const raw = document.getElementById('cast-input').value;
      const cast = raw.split(',').map(n=>parseInt(n,10)).filter(n=>Number.isInteger(n));
      if (!id || cast.length===0) return alert('Need player ID and at least one valid card index');
      const res = await submitCastFor(id, cast);
      const j   = await res.json();
      if (!j.success) return alert('Error: ' + j.error);
      refreshState();
    }

    async function submitClaim() {
      const id = document.getElementById('cast-player-id').value.trim();
      if (!id) return alert('Need player ID');
      const res = await submitClaimFor(id);
      const j   = await res.json();
      if (!j.success) return alert('Error: ' + j.error);
      alert(`Claimed: ${j.claimed.catch.type} @ ${new Date(j.claimed.at).toLocaleTimeString()}`);
      refreshState();
    }

    // — Cast All / Claim All —
    const MAX_CARD_INDEX = 16;
    function randomCast() {
      return Array.from({length:3}, () => Math.floor(Math.random()*(MAX_CARD_INDEX+1)));
    }
    async function castForAll() {
      try {
        const players = await getJSON('/players');
        for (const id of Object.keys(players)) {
          await submitCastFor(id, randomCast());
        }
      } catch (e) { alert('Could not load players'); }
      refreshState();
    }
    async function claimAll() {
      try {
        const list = await getJSON('/unclaimed');
        for (const c of list) {
          await submitClaimFor(c.playerId);
        }
      } catch (e) { alert('Could not load unclaimed'); }
      refreshState();
    }

    // — Refresh Everything —
    async function refreshState() {
      try {
        const { phase, event, hour } = await getJSON('/state');
        document.getElementById('state-phase').textContent = phase;
        document.getElementById('state-event').textContent = event||'None';
        document.getElementById('state-hour').textContent  = hour!=null?hour:'–';

        const players = await getJSON('/players');
        document.getElementById('state-players').innerHTML = Object.entries(players)
          .map(([id,s])=>`<li>${id}: ${JSON.stringify(s)}</li>`)
          .join('') || '<li><em>(no players)</em></li>';

        const casts      = await getJSON('/playercasts');
        const unclaimed  = await getJSON('/unclaimed');
        const history    = await getJSON('/catch-history');

        document.getElementById('state-playercasts').innerHTML = casts
          .map(c=>`<li>${c.playerId}: [${c.cast.join(', ')}] @${new Date(c.timestamp).toLocaleTimeString()}</li>`)
          .join('') || '<li><em>(none)</em></li>';

        document.getElementById('state-unclaimed').innerHTML = unclaimed
          .map(c=>`<li>${c.playerId}: ${c.catch.type} @${new Date(c.at).toLocaleTimeString()}</li>`)
          .join('') || '<li><em>(none)</em></li>';

        document.getElementById('history-list').innerHTML = history.history
          .map(line=>`<li>${line}</li>`).join('') || '<li><em>(none)</em></li>';
      } catch (e) {
        console.error('refreshState error', e);
      }
    }

    // — Wire up buttons & auto-refresh —
    document.getElementById('btn-init').onclick      = submitInit;
    document.getElementById('btn-cast').onclick      = submitCast;
    document.getElementById('btn-claim').onclick     = submitClaim;
    document.getElementById('btn-cast-all').onclick  = castForAll;
    document.getElementById('btn-claim-all').onclick = claimAll;
    document.getElementById('btn-refill').onclick   = refillDecks;

    refreshState();
    setInterval(refreshState, 5000);
  </script>
</body>
</html>